<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Assess a clustering result by calculating the shannon entropy of each cell's mahalanobis distance to all cluster centroids and flagging outliers. — tof_assess_clusters_entropy • tidytof</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Assess a clustering result by calculating the shannon entropy of each cell's mahalanobis distance to all cluster centroids and flagging outliers. — tof_assess_clusters_entropy"><meta name="description" content="This function evaluates the result of a clustering procedure by calculating
the mahalanobis distance between each cell and the centroids of all clusters
in the dataset and finding the shannon entropy of the resulting vector of distances.
All cells with an entropy threshold above a user-specified threshold are flagged
as potentially anomalous. Entropy is minimized (to 0) when a cell is close to
one (or a small number) of clusters, but far from the rest of them. If a cell is
close to multiple cluster centroids (i.e. has an ambiguous phenotype),
its entropy will be large."><meta property="og:description" content="This function evaluates the result of a clustering procedure by calculating
the mahalanobis distance between each cell and the centroids of all clusters
in the dataset and finding the shannon entropy of the resulting vector of distances.
All cells with an entropy threshold above a user-specified threshold are flagged
as potentially anomalous. Entropy is minimized (to 0) when a cell is close to
one (or a small number) of clusters, but far from the rest of them. If a cell is
close to multiple cluster centroids (i.e. has an ambiguous phenotype),
its entropy will be large."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidytof</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/tidytof.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending {tidytof}</h6></li>
    <li><a class="dropdown-item" href="../articles/contributing-to-tidytof.html">How to contribute code</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Cell-level operations</h6></li>
    <li><a class="dropdown-item" href="../articles/reading-and-writing-data.html">Reading and writing data</a></li>
    <li><a class="dropdown-item" href="../articles/quality-control.html">Quality control</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing.html">Preprocessing</a></li>
    <li><a class="dropdown-item" href="../articles/downsampling.html">Downsampling</a></li>
    <li><a class="dropdown-item" href="../articles/dimensionality-reduction.html">Dimensionality reduction</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Cluster-level operations</h6></li>
    <li><a class="dropdown-item" href="../articles/clustering.html">Clustering and metaclustering</a></li>
    <li><a class="dropdown-item" href="../articles/differential-discovery-analysis.html">Differential discovery analysis</a></li>
    <li><a class="dropdown-item" href="../articles/feature-extraction.html">Feature extraction</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Sample-level operations</h6></li>
    <li><a class="dropdown-item" href="../articles/modeling.html">Building predictive models</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/keyes-timothy/tidytof/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Assess a clustering result by calculating the shannon entropy of each cell's mahalanobis distance to all cluster centroids and flagging outliers.</h1>
      <small class="dont-index">Source: <a href="https://github.com/keyes-timothy/tidytof/blob/main/R/quality_control.R" class="external-link"><code>R/quality_control.R</code></a></small>
      <div class="d-none name"><code>tof_assess_clusters_entropy.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function evaluates the result of a clustering procedure by calculating
the mahalanobis distance between each cell and the centroids of all clusters
in the dataset and finding the shannon entropy of the resulting vector of distances.
All cells with an entropy threshold above a user-specified threshold are flagged
as potentially anomalous. Entropy is minimized (to 0) when a cell is close to
one (or a small number) of clusters, but far from the rest of them. If a cell is
close to multiple cluster centroids (i.e. has an ambiguous phenotype),
its entropy will be large.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">tof_assess_clusters_entropy</span><span class="op">(</span></span>
<span>  <span class="va">tof_tibble</span>,</span>
<span>  <span class="va">cluster_col</span>,</span>
<span>  marker_cols <span class="op">=</span> <span class="fu"><a href="where.html">where</a></span><span class="op">(</span><span class="va">tof_is_numeric</span><span class="op">)</span>,</span>
<span>  <span class="va">entropy_threshold</span>,</span>
<span>  entropy_quantile <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>  <span class="va">num_closest_clusters</span>,</span>
<span>  augment <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-tof-tibble">tof_tibble<a class="anchor" aria-label="anchor" href="#arg-tof-tibble"></a></dt>
<dd><p>A `tof_tbl` or `tibble`.</p></dd>


<dt id="arg-cluster-col">cluster_col<a class="anchor" aria-label="anchor" href="#arg-cluster-col"></a></dt>
<dd><p>An unquoted column name indicating which column in `tof_tibble`
stores the cluster ids for the cluster to which each cell belongs.
Cluster labels can be produced via any method the user chooses - including manual gating,
any of the functions in the `tof_cluster_*` function family, or any other method.</p></dd>


<dt id="arg-marker-cols">marker_cols<a class="anchor" aria-label="anchor" href="#arg-marker-cols"></a></dt>
<dd><p>Unquoted column names indicating which column in `tof_tibble`
should be interpreted as markers to be used in the mahalanobis distance calculation.
Defaults to all numeric columns. Supports tidyselection.</p></dd>


<dt id="arg-entropy-threshold">entropy_threshold<a class="anchor" aria-label="anchor" href="#arg-entropy-threshold"></a></dt>
<dd><p>A scalar indicating the entropy threshold above
which a cell should be considered anomalous. If unspecified, a threshold will
be computed using `entropy_quantile` (see below). (Note: Entropy is often between
0 and 1, but can be larger with many classes/clusters).</p></dd>


<dt id="arg-entropy-quantile">entropy_quantile<a class="anchor" aria-label="anchor" href="#arg-entropy-quantile"></a></dt>
<dd><p>A scalar between 0 and 1 indicating the entropy quantile
above which a cell should be considered anomalous. Defaults to 0.9, which means
that cells with an entropy above the 90th percentile will be flagged. Ignored
if entropy_threshold is specified directly.</p></dd>


<dt id="arg-num-closest-clusters">num_closest_clusters<a class="anchor" aria-label="anchor" href="#arg-num-closest-clusters"></a></dt>
<dd><p>An integer indicating how many of a cell's closest
cluster centroids should have their mahalanobis distance included in the entropy
calculation. Playing with this argument will allow you to ignore distances to
clusters that are far away from each cell (and thus may distort the result, as
many distant centroids with large distances can artificially inflate a cells'
entropy value; that being said, this is rarely an issue empirically).
Defaults to all clusters in tof_tibble.</p></dd>


<dt id="arg-augment">augment<a class="anchor" aria-label="anchor" href="#arg-augment"></a></dt>
<dd><p>A boolean value indicating if the output should column-bind the
computed flags for each cell (see below) as new columns in `tof_tibble` (TRUE) or if
a tibble including only the computed flags should be returned (FALSE, the default).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>If augment = FALSE (the default), a tibble with 2 + NUM_CLUSTERS columns.
where NUM_CLUSTERS is the number of unique clusters in cluster_col.
Two of the columns will be "entropy" (the entropy value for each cell) and "flagged_cell"
(a boolean value indicating if each cell had an entropy value above entropy_threshold).
The other NUM_CLUSTERS columns will contain the mahalanobis distances from each cell
to each of the clusters in cluster_col (named ".mahalanobis_{cluster_name}").
If augment = TRUE, the same 2 + NUM_CLUSTERS columns will be column-bound to
tof_tibble, and the resulting tibble will be returned.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># simulate data</span></span></span>
<span class="r-in"><span><span class="va">sim_data</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>        cd45 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cd38 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cd34 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cd19 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, mean <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cluster_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">1000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fl">1000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># imagine a "reference" dataset in which "cluster a" isn't present</span></span></span>
<span class="r-in"><span><span class="va">sim_data_reference</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>    <span class="va">sim_data</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cluster_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># if we cluster into the reference dataset, we will force all cells in</span></span></span>
<span class="r-in"><span><span class="co"># cluster a into a population where they don't fit very well</span></span></span>
<span class="r-in"><span><span class="va">sim_data</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>    <span class="va">sim_data</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="tof_cluster.html">tof_cluster</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>        healthy_tibble <span class="op">=</span> <span class="va">sim_data_reference</span>,</span></span>
<span class="r-in"><span>        healthy_label_col <span class="op">=</span> <span class="va">cluster_id</span>,</span></span>
<span class="r-in"><span>        method <span class="op">=</span> <span class="st">"ddpr"</span></span></span>
<span class="r-in"><span>    <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># we can evaluate the clustering quality by calculating by the entropy of the</span></span></span>
<span class="r-in"><span><span class="co"># mahalanobis distance vector for each cell to all cluster centroids</span></span></span>
<span class="r-in"><span><span class="va">entropy_result</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>    <span class="va">sim_data</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">tof_assess_clusters_entropy</span><span class="op">(</span></span></span>
<span class="r-in"><span>        cluster_col <span class="op">=</span> <span class="va">.mahalanobis_cluster</span>,</span></span>
<span class="r-in"><span>        marker_cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"cd"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        entropy_quantile <span class="op">=</span> <span class="fl">0.8</span>,</span></span>
<span class="r-in"><span>        augment <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span>    <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># most cells in "cluster a" are flagged, and few cells in the other clusters are</span></span></span>
<span class="r-in"><span><span class="va">flagged_cluster_proportions</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>    <span class="va">entropy_result</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>        prop_flagged <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">flagged_cell</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Timothy Keyes.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

