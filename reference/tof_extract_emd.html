<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Extract aggregated features from CyTOF data using earth-mover's distance (EMD) — tof_extract_emd • tidytof</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extract aggregated features from CyTOF data using earth-mover's distance (EMD) — tof_extract_emd"><meta name="description" content="This feature extraction function calculates the earth-mover's distance (EMD) between
the stimulated and unstimulated (&quot;basal&quot;) experimental conditions of samples in a
CyTOF experiment. This calculation is performed across a
user-specified selection of CyTOF antigens and can be performed either
overall (across all cells in the dataset) or after breaking down the cells into
subgroups using `group_cols`."><meta property="og:description" content="This feature extraction function calculates the earth-mover's distance (EMD) between
the stimulated and unstimulated (&quot;basal&quot;) experimental conditions of samples in a
CyTOF experiment. This calculation is performed across a
user-specified selection of CyTOF antigens and can be performed either
overall (across all cells in the dataset) or after breaking down the cells into
subgroups using `group_cols`."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidytof</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/tidytof.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending {tidytof}</h6></li>
    <li><a class="dropdown-item" href="../articles/contributing-to-tidytof.html">How to contribute code</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Cell-level operations</h6></li>
    <li><a class="dropdown-item" href="../articles/reading-and-writing-data.html">Reading and writing data</a></li>
    <li><a class="dropdown-item" href="../articles/quality-control.html">Quality control</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing.html">Preprocessing</a></li>
    <li><a class="dropdown-item" href="../articles/downsampling.html">Downsampling</a></li>
    <li><a class="dropdown-item" href="../articles/dimensionality-reduction.html">Dimensionality reduction</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Cluster-level operations</h6></li>
    <li><a class="dropdown-item" href="../articles/clustering.html">Clustering and metaclustering</a></li>
    <li><a class="dropdown-item" href="../articles/differential-discovery-analysis.html">Differential discovery analysis</a></li>
    <li><a class="dropdown-item" href="../articles/feature-extraction.html">Feature extraction</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Sample-level operations</h6></li>
    <li><a class="dropdown-item" href="../articles/modeling.html">Building predictive models</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/keyes-timothy/tidytof/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Extract aggregated features from CyTOF data using earth-mover's distance (EMD)</h1>
      <small class="dont-index">Source: <a href="https://github.com/keyes-timothy/tidytof/blob/main/R/feature_extraction.R" class="external-link"><code>R/feature_extraction.R</code></a></small>
      <div class="d-none name"><code>tof_extract_emd.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This feature extraction function calculates the earth-mover's distance (EMD) between
the stimulated and unstimulated ("basal") experimental conditions of samples in a
CyTOF experiment. This calculation is performed across a
user-specified selection of CyTOF antigens and can be performed either
overall (across all cells in the dataset) or after breaking down the cells into
subgroups using `group_cols`.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">tof_extract_emd</span><span class="op">(</span></span>
<span>  <span class="va">tof_tibble</span>,</span>
<span>  <span class="va">cluster_col</span>,</span>
<span>  group_cols <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  marker_cols <span class="op">=</span> <span class="fu"><a href="where.html">where</a></span><span class="op">(</span><span class="va">tof_is_numeric</span><span class="op">)</span>,</span>
<span>  <span class="va">emd_col</span>,</span>
<span>  <span class="va">reference_level</span>,</span>
<span>  format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"wide"</span>, <span class="st">"long"</span><span class="op">)</span>,</span>
<span>  num_bins <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-tof-tibble">tof_tibble<a class="anchor" aria-label="anchor" href="#arg-tof-tibble"></a></dt>
<dd><p>A `tof_tbl` or a `tibble`.</p></dd>


<dt id="arg-cluster-col">cluster_col<a class="anchor" aria-label="anchor" href="#arg-cluster-col"></a></dt>
<dd><p>An unquoted column name indicating which column in `tof_tibble`
stores the cluster ids of the cluster to which each cell belongs.
Cluster labels can be produced via any method the user chooses - including manual gating,
any of the functions in the `tof_cluster_*` function family, or any other method.</p></dd>


<dt id="arg-group-cols">group_cols<a class="anchor" aria-label="anchor" href="#arg-group-cols"></a></dt>
<dd><p>Unquoted column names representing which columns in `tof_tibble`
should be used to break the rows of `tof_tibble` into subgroups for the feature
extraction calculation. Defaults to NULL (i.e. performing the extraction without subgroups).</p></dd>


<dt id="arg-marker-cols">marker_cols<a class="anchor" aria-label="anchor" href="#arg-marker-cols"></a></dt>
<dd><p>Unquoted column names representing which columns in `tof_tibble`
(i.e. which CyTOF protein measurements) should be included in the earth-mover's distance
calculation. Defaults to all numeric (integer or double) columns.
Supports tidyselect helpers.</p></dd>


<dt id="arg-emd-col">emd_col<a class="anchor" aria-label="anchor" href="#arg-emd-col"></a></dt>
<dd><p>An unquoted column name that indicates which
column in `tof_tibble` should be used to group cells into different distributions
to be compared with one another during the EMD calculation. For example,
if you want to compare marker expression distributions across stimulation
conditions, `emd_col` should be the column in `tof_tibble` containing
information about which stimulation condition each cell
was exposed to during data acquisition.</p>
<p>If provided, the feature extraction will be
further broken down into subgroups by stimulation condition (and features from each stimulation
condition will be included as their own features in wide format).</p></dd>


<dt id="arg-reference-level">reference_level<a class="anchor" aria-label="anchor" href="#arg-reference-level"></a></dt>
<dd><p>A string indicating what the value in `emd_col`
corresponds to the "reference" value to which all other values in `emd_col`
should be compared. For example, if `emd_col` represents the stimulation
condition for a cell, reference_level might take the value of "basal" or
"unstimulated" if you want to compare each stimulation to the basal state.</p></dd>


<dt id="arg-format">format<a class="anchor" aria-label="anchor" href="#arg-format"></a></dt>
<dd><p>A string indicating if the data should be returned in "wide" format
(the default; each cluster feature is given its own column) or in "long" format
(each cluster feature is provided as its own row).</p></dd>


<dt id="arg-num-bins">num_bins<a class="anchor" aria-label="anchor" href="#arg-num-bins"></a></dt>
<dd><p>Optional. The number of bins to use in dividing one-dimensional
marker distributions into discrete segments for the EMD calculation. Defaults to 100.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A tibble.</p>
<p>If format == "wide", the tibble will have 1 row for each combination of
the grouping variables provided in `group_cols` and one column for each grouping variable,
one column for each extracted feature (the EMD between the distribution of a
given marker in a given cluster in the basal condition and the distribution of
that marker in a given cluster in a stimulated condition).
The names of each column containing cluster features is obtained using the following pattern:
"{stimulation_id}_{marker_id}@{cluster_id}_emd".</p>
<p>If format == "long", the tibble will have 1 row for each combination of the grouping variables
in `group_cols`, each cluster id (i.e. level) in `cluster_col`, and each marker in `marker_cols`.
It will have one column for each grouping variable, one column for the cluster ids, one
column for the CyTOF channel names, and one column (`value`) containing the features.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other feature extraction functions:
<code><a href="tof_extract_central_tendency.html">tof_extract_central_tendency</a>()</code>,
<code><a href="tof_extract_features.html">tof_extract_features</a>()</code>,
<code><a href="tof_extract_jsd.html">tof_extract_jsd</a>()</code>,
<code><a href="tof_extract_proportion.html">tof_extract_proportion</a>()</code>,
<code><a href="tof_extract_threshold.html">tof_extract_threshold</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">sim_data</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>        cd45 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cd38 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cd34 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cd19 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        cluster_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">letters</span>, size <span class="op">=</span> <span class="fl">1000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        patient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"kirby"</span>, <span class="st">"mario"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        stim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basal"</span>, <span class="st">"stim"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># extract emd of each cluster in each patient (using the "basal" stim</span></span></span>
<span class="r-in"><span><span class="co"># condition as a reference) in wide format</span></span></span>
<span class="r-in"><span><span class="fu">tof_extract_emd</span><span class="op">(</span></span></span>
<span class="r-in"><span>    tof_tibble <span class="op">=</span> <span class="va">sim_data</span>,</span></span>
<span class="r-in"><span>    cluster_col <span class="op">=</span> <span class="va">cluster_id</span>,</span></span>
<span class="r-in"><span>    group_cols <span class="op">=</span> <span class="va">patient</span>,</span></span>
<span class="r-in"><span>    emd_col <span class="op">=</span> <span class="va">stim</span>,</span></span>
<span class="r-in"><span>    reference_level <span class="op">=</span> <span class="st">"basal"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 2 × 105</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   patient `stim_cd45@t_emd` `stim_cd38@t_emd` `stim_cd34@t_emd`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> kirby                <span style="color: #BB0000;">NA</span>                <span style="color: #BB0000;">NA</span>               <span style="color: #BB0000;">NA</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> mario                14.3              10.3              9.99</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># ℹ 101 more variables: `stim_cd19@t_emd` &lt;dbl&gt;, `stim_cd45@w_emd` &lt;dbl&gt;,</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;">#   `stim_cd38@w_emd` &lt;dbl&gt;, `stim_cd34@w_emd` &lt;dbl&gt;, `stim_cd19@w_emd` &lt;dbl&gt;,</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;">#   `stim_cd45@v_emd` &lt;dbl&gt;, `stim_cd38@v_emd` &lt;dbl&gt;, `stim_cd34@v_emd` &lt;dbl&gt;,</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;">#   `stim_cd19@v_emd` &lt;dbl&gt;, `stim_cd45@e_emd` &lt;dbl&gt;, `stim_cd38@e_emd` &lt;dbl&gt;,</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;">#   `stim_cd34@e_emd` &lt;dbl&gt;, `stim_cd19@e_emd` &lt;dbl&gt;, `stim_cd45@s_emd` &lt;dbl&gt;,</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;">#   `stim_cd38@s_emd` &lt;dbl&gt;, `stim_cd34@s_emd` &lt;dbl&gt;, `stim_cd19@s_emd` &lt;dbl&gt;,</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;">#   `stim_cd45@f_emd` &lt;dbl&gt;, `stim_cd38@f_emd` &lt;dbl&gt;, …</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># extract emd of each cluster (using the "basal" stim</span></span></span>
<span class="r-in"><span><span class="co"># condition as a reference) in long format</span></span></span>
<span class="r-in"><span><span class="fu">tof_extract_emd</span><span class="op">(</span></span></span>
<span class="r-in"><span>    tof_tibble <span class="op">=</span> <span class="va">sim_data</span>,</span></span>
<span class="r-in"><span>    cluster_col <span class="op">=</span> <span class="va">cluster_id</span>,</span></span>
<span class="r-in"><span>    emd_col <span class="op">=</span> <span class="va">stim</span>,</span></span>
<span class="r-in"><span>    reference_level <span class="op">=</span> <span class="st">"basal"</span>,</span></span>
<span class="r-in"><span>    format <span class="op">=</span> <span class="st">"long"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 104 × 4</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    cluster_id marker stimulation   emd</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 1</span> t          cd45   stim        13.5 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 2</span> t          cd38   stim         4.68</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 3</span> t          cd34   stim        10.9 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 4</span> t          cd19   stim         7.83</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 5</span> w          cd45   stim         4.65</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 6</span> w          cd38   stim         6.85</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 7</span> w          cd34   stim         6.15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 8</span> w          cd19   stim         4.67</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 9</span> v          cd45   stim        12.5 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">10</span> v          cd38   stim         8.5 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># ℹ 94 more rows</span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Timothy Keyes.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

