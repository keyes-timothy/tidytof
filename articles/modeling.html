<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Read this vignette to learn how to compute summary statistics like cluster  abundance and cluster marker expression using {tidytof} 
">
<title>Building predictive models • tidytof</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building predictive models">
<meta property="og:description" content="Read this vignette to learn how to compute summary statistics like cluster  abundance and cluster marker expression using {tidytof} 
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tidytof</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/tidytof.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Extending {tidytof}</h6>
    <a class="dropdown-item" href="../articles/contributing-to-tidytof.html">How to contribute code</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Cell-level operations</h6>
    <a class="dropdown-item" href="../articles/reading-and-writing-data.html">Reading and writing data</a>
    <a class="dropdown-item" href="../articles/quality-control.html">Quality control</a>
    <a class="dropdown-item" href="../articles/preprocessing.html">Preprocessing</a>
    <a class="dropdown-item" href="../articles/downsampling.html">Downsampling</a>
    <a class="dropdown-item" href="../articles/dimensionality-reduction.html">Dimensionality reduction</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Cluster-level operations</h6>
    <a class="dropdown-item" href="../articles/clustering.html">Clustering and metaclustering</a>
    <a class="dropdown-item" href="../articles/differential-discovery-analysis.html">Differential discovery analysis</a>
    <a class="dropdown-item" href="../articles/feature-extraction.html">Feature extraction</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Sample-level operations</h6>
    <a class="dropdown-item" href="../articles/modeling.html">Building predictive models</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Building predictive models</h1>
                        <h4 data-toc-skip class="author">Timothy
Keyes</h4>
            
            <h4 data-toc-skip class="date">2023-05-08</h4>
      
      
      <div class="d-none name"><code>modeling.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keyes-timothy.github.io/tidytof">tidytof</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span></code></pre></div>
<p><a href="https://keyes-timothy.github.io/tidytof">tidytof</a> implements several functions for building
predictive models using sample- or patient-level data.</p>
<div class="section level2">
<h2 id="accessing-the-data-for-this-vignette">Accessing the data for this vignette<a class="anchor" aria-label="anchor" href="#accessing-the-data-for-this-vignette"></a>
</h2>
<p>To illustrate how they work, first we download some patient-level
data from <a href="https://pubmed.ncbi.nlm.nih.gov/29505032/" class="external-link">this
paper</a> and combine it with sample-level clinical annotations in one
of <a href="https://keyes-timothy.github.io/tidytof">tidytof</a>’s built-in datasets
(<code>ddpr_metadata</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ddpr_metadata</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># link for downloading the sample-level data from the Nature Medicine website</span></span>
<span><span class="va">data_link</span> <span class="op">&lt;-</span> </span>
<span>  <span class="st">"https://static-content.springer.com/esm/art%3A10.1038%2Fnm.4505/MediaObjects/41591_2018_BFnm4505_MOESM3_ESM.csv"</span></span>
<span></span>
<span><span class="co"># download the data and combine it with clinical annotations</span></span>
<span><span class="va">ddpr_patients</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">data_link</span>, skip <span class="op">=</span> <span class="fl">2L</span>, n_max <span class="op">=</span> <span class="fl">78L</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>patient_id <span class="op">=</span> <span class="va">Patient_ID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ddpr_metadata</span>, by <span class="op">=</span> <span class="st">"patient_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">patient_id</span>, <span class="st">"Healthy"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># preview only the metadata (i.e. non-numeric) columns </span></span>
<span><span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="../reference/where.html">where</a></span><span class="op">(</span><span class="op">~</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">#&gt;   patient_id gender mrd_risk nci_rome_risk relapse_status type_of_relapse cohort</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> UPN1       Male   Interme… Standard      Yes            Early           Train…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> UPN1-Rx    Male   Interme… Standard      Yes            Early           Train…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> UPN2       Male   Interme… Standard      No             <span style="color: #BB0000;">NA</span>              Train…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> UPN3       Female Standard Standard      No             <span style="color: #BB0000;">NA</span>              Train…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> UPN4       Male   Standard Standard      No             <span style="color: #BB0000;">NA</span>              Valid…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> UPN5       Female Standard High          No             <span style="color: #BB0000;">NA</span>              Valid…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: ddpr_risk &lt;chr&gt;</span></span></span></code></pre></div>
<p>The data processing steps above result in a tibble called
<code>ddpr_patients</code>. The numeric columns in
<code>ddpr_patients</code> represent aggregated cell population features
for each sample (see <a href="https://www.nature.com/articles/nm.4505#MOESM3" class="external-link">Supplementary
Table 5 in this paper</a> for details). The non-numeric columns
represent clinical metadata about each sample (run
<code><a href="../reference/ddpr_metadata.html">?ddpr_metadata</a></code> for more information). Of the metadata
columns, the most important are the ones that indicate if a patient will
develop refractory disease (“relapse”), and when/if that will happen.
This information is stored in the <code>relapse_status</code> and
<code>time_to_relapse</code> columns, respectively.</p>
<p>There are also a few preprocessing steps that we might want to
perform now to save us some headaches when we’re fitting models
later.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ddpr_patients</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># convert the relapse_status variable to a factor</span></span>
<span>  <span class="co"># and create the time_to_event and event columns for survival modeling</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    relapse_status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span>, </span>
<span>    time_to_event <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">relapse_status</span> <span class="op">==</span> <span class="st">"Yes"</span>, <span class="va">time_to_relapse</span>, <span class="va">ccr</span><span class="op">)</span>,</span>
<span>    event <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">relapse_status</span> <span class="op">==</span> <span class="st">"Yes"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>In the next part of this vignette, we’ll use this patient-level data
to build some predictive models using resampling procedures like k-fold
cross-validation and bootstrapping.</p>
</div>
<div class="section level2">
<h2 id="building-a-classifier-using-elastic-net-regularized-logistic-regression">Building a classifier using elastic net-regularized logistic
regression<a class="anchor" aria-label="anchor" href="#building-a-classifier-using-elastic-net-regularized-logistic-regression"></a>
</h2>
<p>First, we can build an elastic net classifier to predict which
patients will relapse and which patients won’t (ignoring time-to-event
data for now). For this, we can use the <code>relapse_status</code>
column in <code>ddpr_patients</code> as the outcome variable:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># find how many of each outcome we have in our cohort</span></span>
<span><span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;   relapse_status     n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> No                37</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Yes               24</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="color: #BB0000;">NA</span>                12</span></span></code></pre></div>
<p>We can see that not all of our samples are annotated, so we can throw
away all the samples that don’t have a clinical outcome associated with
them.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ddpr_patients_unannotated</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ddpr_patients</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In the original DDPR paper, 10-fold cross-validation was used to tune
a glmnet model and to estimate the error of that model on new datasets.
Here, we can use the <code><a href="../reference/tof_split_data.html">tof_split_data()</a></code> function to split our
cohort into a training and test set either once 10 times using k-fold
cross-validation or bootstrapping. Reading the documentation of
<code><a href="../reference/tof_split_data.html">tof_split_data()</a></code> demonstrates how to use other resampling
methods (like bootstrapping).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3000L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">training_split</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_split_data.html">tof_split_data</a></span><span class="op">(</span></span>
<span>    split_method <span class="op">=</span> <span class="st">"k-fold"</span>, </span>
<span>    num_cv_folds <span class="op">=</span> <span class="fl">10</span>, </span>
<span>    strata <span class="op">=</span> <span class="va">relapse_status</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">training_split</span></span>
<span><span class="co">#&gt; #  10-fold cross-validation using stratification </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 2</span></span></span>
<span><span class="co">#&gt;    splits         id    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> <span style="color: #949494;">&lt;split [54/7]&gt;</span> Fold01</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="color: #949494;">&lt;split [54/7]&gt;</span> Fold02</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> <span style="color: #949494;">&lt;split [54/7]&gt;</span> Fold03</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> <span style="color: #949494;">&lt;split [54/7]&gt;</span> Fold04</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> <span style="color: #949494;">&lt;split [55/6]&gt;</span> Fold05</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> <span style="color: #949494;">&lt;split [55/6]&gt;</span> Fold06</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="color: #949494;">&lt;split [55/6]&gt;</span> Fold07</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="color: #949494;">&lt;split [56/5]&gt;</span> Fold08</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="color: #949494;">&lt;split [56/5]&gt;</span> Fold09</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> <span style="color: #949494;">&lt;split [56/5]&gt;</span> Fold10</span></span></code></pre></div>
<p>The output of <code><a href="../reference/tof_split_data.html">tof_split_data()</a></code> varies depending on which
<code>split_method</code> is used. For cross-validation, the result is a
<code>rset</code> object from the <a href="https://rsample.tidymodels.org/" class="external-link">rsample</a> package.
<code>rset</code> objects are a type of tibble with two columns:</p>
<ul>
<li>
<code>splits</code> - a column in which each entry is an
<code>rsplit</code> object (which contains a single resample of the full
dataset)</li>
<li>
<code>id</code> - a character column in which each entry represents
the name of the fold that each entry in <code>splits</code> belongs
to.</li>
</ul>
<p>We can inspect one of the resamples in the <code>splits</code> column
to see what they contain:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_resample</span> <span class="op">&lt;-</span> <span class="va">training_split</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">my_resample</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Analysis/Assess/Total&gt;</span></span>
<span><span class="co">#&gt; &lt;54/7/61&gt;</span></span></code></pre></div>
<p>Note that you can use <code><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">rsample::training</a></code> and
<code><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">rsample::testing</a></code> to return the training and test
observations from each resampling:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_resample</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 1,854</span></span></span>
<span><span class="co">#&gt;   patient_id Pop_P_Pop1 CD19_Pop1 CD20_Pop1 CD24_Pop1 CD34_Pop1 CD38_Pop1</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> UPN1           3.06      0.583    0.004<span style="text-decoration: underline;">49</span>    0.164       1.94     0.416</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> UPN1-Rx        0.039<span style="text-decoration: underline;">5</span>    0.618    0.063<span style="text-decoration: underline;">4</span>     0.572       2.93     0.944</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> UPN2           0.139     0.066<span style="text-decoration: underline;">2</span>   0.022<span style="text-decoration: underline;">1</span>     0.082<span style="text-decoration: underline;">5</span>      2.25     0.454</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> UPN3           0.633     0.023<span style="text-decoration: underline;">4</span>   0.016<span style="text-decoration: underline;">5</span>     0.032<span style="text-decoration: underline;">7</span>      2.25     0.226</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> UPN4           0.044<span style="text-decoration: underline;">3</span>    0.129    0.044<span style="text-decoration: underline;">7</span>     0.232       2.47     0.336</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> UPN5           0.064<span style="text-decoration: underline;">7</span>    0.057<span style="text-decoration: underline;">7</span>   0.016<span style="text-decoration: underline;">3</span>     0.162       2.89     0.406</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,847 more variables: CD127_Pop1 &lt;dbl&gt;, CD179a_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   CD179b_Pop1 &lt;dbl&gt;, IgMi_Pop1 &lt;dbl&gt;, IgMs_Pop1 &lt;dbl&gt;, TdT_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   CD22_Pop1 &lt;dbl&gt;, tIkaros_Pop1 &lt;dbl&gt;, CD79b_Pop1 &lt;dbl&gt;, Ki67_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   TSLPr_Pop1 &lt;dbl&gt;, RAG1_Pop1 &lt;dbl&gt;, CD123_Pop1 &lt;dbl&gt;, CD45_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   CD10_Pop1 &lt;dbl&gt;, Pax5_Pop1 &lt;dbl&gt;, CD43_Pop1 &lt;dbl&gt;, CD58_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   HLADR_Pop1 &lt;dbl&gt;, p4EBP1_FC_Basal_Pop1 &lt;dbl&gt;, pSTAT5_FC_Basal_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   pPLCg1_2_FC_Basal_Pop1 &lt;dbl&gt;, pAkt_FC_Basal_Pop1 &lt;dbl&gt;, …</span></span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_resample</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 1,854</span></span></span>
<span><span class="co">#&gt;   patient_id Pop_P_Pop1 CD19_Pop1 CD20_Pop1 CD24_Pop1 CD34_Pop1 CD38_Pop1</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> UPN6          5.62      0.550     0.003<span style="text-decoration: underline;">74</span>     0.622      2.86     0.342</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> UPN10-Rx      0.002<span style="text-decoration: underline;">40</span>   0.167     0.203       0.802      2.57     0.822</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> UPN13         0.063<span style="text-decoration: underline;">4</span>    0.030<span style="text-decoration: underline;">0</span>    0.021<span style="text-decoration: underline;">9</span>      0.109      2.34     0.314</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> UPN22-Rx      0.064<span style="text-decoration: underline;">3</span>    1.68      0.080<span style="text-decoration: underline;">4</span>      1.56       3.06     0.529</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> UPN58         0.005<span style="text-decoration: underline;">46</span>   0.009<span style="text-decoration: underline;">18</span>   0.016<span style="text-decoration: underline;">8</span>      0.480      2.70     0.112</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> UPN95         0.300     0.389     0.004<span style="text-decoration: underline;">54</span>     0.697      2.45     0.247</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,847 more variables: CD127_Pop1 &lt;dbl&gt;, CD179a_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   CD179b_Pop1 &lt;dbl&gt;, IgMi_Pop1 &lt;dbl&gt;, IgMs_Pop1 &lt;dbl&gt;, TdT_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   CD22_Pop1 &lt;dbl&gt;, tIkaros_Pop1 &lt;dbl&gt;, CD79b_Pop1 &lt;dbl&gt;, Ki67_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   TSLPr_Pop1 &lt;dbl&gt;, RAG1_Pop1 &lt;dbl&gt;, CD123_Pop1 &lt;dbl&gt;, CD45_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   CD10_Pop1 &lt;dbl&gt;, Pax5_Pop1 &lt;dbl&gt;, CD43_Pop1 &lt;dbl&gt;, CD58_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   HLADR_Pop1 &lt;dbl&gt;, p4EBP1_FC_Basal_Pop1 &lt;dbl&gt;, pSTAT5_FC_Basal_Pop1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   pPLCg1_2_FC_Basal_Pop1 &lt;dbl&gt;, pAkt_FC_Basal_Pop1 &lt;dbl&gt;, …</span></span></span></code></pre></div>
<p>From here, we can feed <code>training_split</code> into the
<code>tof_train_model</code> function to <a href="https://www.tmwr.org/tuning.html" class="external-link">tune</a> a logistic regression
model that predicts the relapse_status of a leukemia patient. Be sure to
check out the <code>tof_create_grid</code> documentation to learn how to
make a hyperparameter search grid for model tuning (in this case, we
limit the mixture parameter to a value of 1, which fits a sparse lasso
model).</p>
<p>Also note that, in this case, for illustrative purposes we’re only
incorporating features from <strong>one</strong> of the populations of
interest (population 2) into the model, whereas the original model
incorporated features from all 12 populations (and likely required quite
a bit of computational power as a result).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hyperparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tof_create_grid.html">tof_create_grid</a></span><span class="op">(</span>mixture_values <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">class_mod</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">training_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_train_model.html">tof_train_model</a></span><span class="op">(</span></span>
<span>    predictor_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"Pop2"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    response_col <span class="op">=</span> <span class="va">relapse_status</span>,</span>
<span>    model_type <span class="op">=</span> <span class="st">"two-class"</span>, </span>
<span>    hyperparameter_grid <span class="op">=</span> <span class="va">hyperparams</span>, </span>
<span>    impute_missing_predictors <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    remove_zv_predictors <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># often a smart decision</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The output of <code>tof_train_model</code> is a
<code>tof_model</code>, an object containing information about the
trained model (and that can be passed to the <code>tof_predict</code>
and <code>tof_assess_model</code> verbs). When a <code>tof_model</code>
is printed, some information about the optimal hyperparamters is
printed, and so is a table of the nonzero model coefficients in the
model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">class_mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; A two-class `tof_model` with a mixture parameter (alpha) of 1 and a penalty parameter (lambda) of 1e-10 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 28 × 2</span></span></span>
<span><span class="co">#&gt;    feature               coefficient</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> p4EBP1_dP_IL7_Pop2          -<span style="color: #BB0000;">3.10</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> pCreb_dP_PVO4_Pop2          -<span style="color: #BB0000;">2.66</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> TSLPr_Pop2                   2.07</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> CD43_Pop2                    2.00</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> pSTAT5_FC_PVO4_Pop2         -<span style="color: #BB0000;">1.80</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> pS6_dP_IL7_Pop2              1.56</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> pPLCg1_2_dP_PVO4_Pop2        1.44</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> (Intercept)                 -<span style="color: #BB0000;">1.43</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> pSTAT5_FC_BCR_Pop2           1.24</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> pErk_dP_IL7_Pop2            -<span style="color: #BB0000;">1.23</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 18 more rows</span></span></span></code></pre></div>
<p>After training our model, we might be interested in seeing how it
performs. One way to assess a classification model is to see how well it
works when applied directly back to the data it was trained on (the
model’s “training data”). To do so, we can use the
<code><a href="../reference/tof_assess_model.html">tof_assess_model()</a></code> function with no arguments:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_classifier_metrics</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">class_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_assess_model.html">tof_assess_model</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/tof_assess_model.html">tof_assess_model()</a></code> returns a list of several model
assessment metrics that differ depending on the kind of
<code>tof_model</code> you trained. For two-class classifier models,
among the most useful of these is the <code>confusion_matrix</code>,
which shows how your classifier classified each observation relative to
its true class assignment.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_classifier_metrics</span><span class="op">$</span><span class="va">confusion_matrix</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;   true_outcome predicted_outcome num_observations</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> No           No                              37</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> No           Yes                              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Yes          No                               0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Yes          Yes                             24</span></span></code></pre></div>
<p>In this case, we can see that our model performed perfectly on its
training data (which is expected, as the model was optimized using these
data themselves!). You can also visualize the model’s performance using
the <code><a href="../reference/tof_plot_model.html">tof_plot_model()</a></code> verb, which in the case of a two-class
model will give us a Receiver-Operating Characteristic (ROC) curve:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">class_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_plot_model.html">tof_plot_model</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeling_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>As shown above, <code><a href="../reference/tof_plot_model.html">tof_plot_model()</a></code> will return a
receiver-operating curve for a two-class model. While it’s unusual to
get an AUC of 1 in the machine learning world, we can note that in this
case, our classification problem wasn’t particularly difficult (and we
had a lot of input features to work with).</p>
<p>After training a model, it generally isn’t sufficient to evaluate how
a model performs on the training data alone, as doing so will provide an
overly-optimistic representation of how the model would perform on data
it’s never seen before (this problem is often called “overfitting” the
model to the training data). To get a fairer estimate of our model’s
performance on new datasets, we can also evaluate its cross-validation
error by calling <code><a href="../reference/tof_assess_model.html">tof_assess_model()</a></code> and
<code><a href="../reference/tof_plot_model.html">tof_plot_model()</a></code> with the <code>new_data</code> argument
set to “tuning”.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_classifier_metrics</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">class_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_assess_model.html">tof_assess_model</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="st">"tuning"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">class_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_plot_model.html">tof_plot_model</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="st">"tuning"</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeling_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>In this case, we plot an ROC Curve using the predictions for each
observation when it was <strong>excluded</strong> from model training
during cross-validation, an approach that gives a more accurate estimate
of a model’s performance on new data than simple evaluation on the
training dataset.</p>
</div>
<div class="section level2">
<h2 id="building-a-survival-model-using-elastic-net-regularized-cox-regression">Building a survival model using elastic net-regularized cox
regression<a class="anchor" aria-label="anchor" href="#building-a-survival-model-using-elastic-net-regularized-cox-regression"></a>
</h2>
<p>Building off of the ideas above, a more sophisticated way to model
our data is not simply to predict who will relapse and who won’t, but to
build a time-to-event model that estimates patients’ probabilities of
relapse as a function of time since diagnosis. This approach is called
“survival modeling” (specifically, in this case we use Cox-proportional
hazards modeling) because it takes into account that patients have
adverse events at different times during their course of disease
(i.e. not everyone who relapses does so at the same time).</p>
<p>To build a survival model using <a href="https://keyes-timothy.github.io/tidytof">tidytof</a>, use the
<code><a href="../reference/tof_train_model.html">tof_train_model()</a></code> verb while setting the
<code>model_type</code> flag to “survival”. In addition, you need to
provide two outcome columns. The first of these columns
(<code>event_col</code>) indicates if a patient relapsed
(i.e. experienced the event-of-interest) or if they were censored after
a certain amount of follow-up time. The second (<code>time_col</code>)
indicates how much time it took for the patient to relapse or to be
censored from the analysis.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hyperparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tof_create_grid.html">tof_create_grid</a></span><span class="op">(</span>mixture_values <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">survival_mod</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">training_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_train_model.html">tof_train_model</a></span><span class="op">(</span></span>
<span>    predictor_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"Pop2"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    time_col <span class="op">=</span> <span class="va">time_to_event</span>, </span>
<span>    event_col <span class="op">=</span> <span class="va">event</span>, </span>
<span>    model_type <span class="op">=</span> <span class="st">"survival"</span>, </span>
<span>    hyperparameter_grid <span class="op">=</span> <span class="va">hyperparams</span>, </span>
<span>    impute_missing_predictors <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    remove_zv_predictors <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># often a smart decision</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">survival_mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; A survival `tof_model` with a mixture parameter (alpha) of 1 and a penalty parameter (lambda) of 3.162e-03 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 40 × 2</span></span></span>
<span><span class="co">#&gt;    feature               coefficient</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> pErk_dP_TSLP_Pop2           -<span style="color: #BB0000;">7.03</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> pCreb_dP_PVO4_Pop2          -<span style="color: #BB0000;">5.47</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> CD19_Pop2                   -<span style="color: #BB0000;">3.73</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> CD34_Pop2                    3.63</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> pSTAT5_FC_BCR_Pop2           3.40</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> HLADR_Pop2                  -<span style="color: #BB0000;">3.38</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> pPLCg1_2_dP_IL7_Pop2         3.33</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> pPLCg1_2_dP_PVO4_Pop2        3.14</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> pSyk_dP_TSLP_Pop2            2.88</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> CD123_Pop2                   2.77</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 30 more rows</span></span></span></code></pre></div>
<p>Once a survival model is trained, it can be used to predict a
patient’s probability of the event-of-interest at different times
post-diagnosis. However, the most common way that survival models are
applied in practice is to use each patient’s predicted relative risk of
the event-of-interest to divide patients into low- and high-risk
subgroups. <a href="https://keyes-timothy.github.io/tidytof">tidytof</a> can do this automatically according to
the most optimal split obtained using the log-rank test of all possible
split points in the dataset with <code><a href="../reference/tof_assess_model.html">tof_assess_model()</a></code>. In
addition, it will return the predicted survival curve for each patient
over time:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">survival_metrics</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">survival_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_assess_model.html">tof_assess_model</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">survival_metrics</span></span>
<span><span class="co">#&gt; $model_metrics</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;   metric                        value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> neg_log_partial_likelihood 1.76<span style="color: #949494;">e</span>+ 1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> concordance_index          1   <span style="color: #949494;">e</span>+ 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> log_rank_p_value           1.47<span style="color: #949494;">e</span><span style="color: #BB0000;">-22</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $survival_curves</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 61 × 6</span></span></span>
<span><span class="co">#&gt;    row_index survival_curve    relative_risk time_to_event event risk_group</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>                    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       2.83<span style="color: #949494;">e</span>+3          <span style="text-decoration: underline;">1</span>043     1 low       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       2.61<span style="color: #949494;">e</span>+3          <span style="text-decoration: underline;">1</span>043     1 low       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 3         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       1.58<span style="color: #949494;">e</span><span style="color: #BB0000;">-8</span>          <span style="text-decoration: underline;">5</span>406     0 low       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 4         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       2.09<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>          <span style="text-decoration: underline;">4</span>917     0 low       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 5         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       9.98<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span>          <span style="text-decoration: underline;">4</span>538     0 low       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 6         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       6.62<span style="color: #949494;">e</span><span style="color: #BB0000;">-1</span>          <span style="text-decoration: underline;">4</span>490     0 low       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 7         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       4.09<span style="color: #949494;">e</span>+9           136     1 high      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 8         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       2.57<span style="color: #949494;">e</span>+8           364     1 high      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 9         <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       1.27<span style="color: #949494;">e</span>+9           237     1 high      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 10        <span style="color: #949494;">&lt;tibble [54 × 2]&gt;</span>       2.31<span style="color: #949494;">e</span>+4           886     1 low       </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 51 more rows</span></span></span></code></pre></div>
<p>For survival models, <code><a href="../reference/tof_plot_model.html">tof_plot_model()</a></code> plots the average
survival curves for both the low- and high-risk groups:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">survival_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_plot_model.html">tof_plot_model</a></span><span class="op">(</span><span class="op">)</span> </span></code></pre></div>
<p><img src="modeling_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_survival_metrics</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">survival_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/tof_assess_model.html">tof_assess_model</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="st">"tuning"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">survival_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tof_plot_model.html">tof_plot_model</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="st">"tuning"</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeling_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Timothy Keyes.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
