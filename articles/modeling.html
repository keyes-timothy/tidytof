<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Read this vignette to learn how to compute summary statistics like cluster  abundance and cluster marker expression using {tidytof} 
">
<title>Building predictive models • tidytof</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building predictive models">
<meta property="og:description" content="Read this vignette to learn how to compute summary statistics like cluster  abundance and cluster marker expression using {tidytof} 
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tidytof</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/tidytof.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Cell-level operations</h6>
    <a class="dropdown-item" href="../articles/reading-and-writing-data.html">Reading and writing data</a>
    <a class="dropdown-item" href="../articles/preprocessing.html">Preprocessing</a>
    <a class="dropdown-item" href="../articles/downsampling.html">Downsampling</a>
    <a class="dropdown-item" href="../articles/dimensionality-reduction.html">Dimensionality reduction</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Cluster-level operations</h6>
    <a class="dropdown-item" href="../articles/clustering.html">Clustering and metaclustering</a>
    <a class="dropdown-item" href="../articles/differential-discovery-analysis.html">Differential discovery analysis</a>
    <a class="dropdown-item" href="../articles/feature-extraction.html">Feature extraction</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Sample-level operations</h6>
    <a class="dropdown-item" href="../articles/modeling.html">Building predictive models</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="modeling_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Building predictive models</h1>
                        <h4 data-toc-skip class="author">Timothy Keyes</h4>
            
            <h4 data-toc-skip class="date">2022-01-30</h4>
      
      
      <div class="d-none name"><code>modeling.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keyes-timothy.github.io/tidytof">tidytof</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></code></pre></div>
<p><a href="https://keyes-timothy.github.io/tidytof">tidytof</a> implements several functions for building predictive models using sample- or patient-level data.</p>
<div class="section level2">
<h2 id="accessing-the-data-for-this-vignette">Accessing the data for this vignette<a class="anchor" aria-label="anchor" href="#accessing-the-data-for-this-vignette"></a>
</h2>
<p>To illustrate how they work, first we download some patient-level data from <a href="https://pubmed.ncbi.nlm.nih.gov/29505032/" class="external-link">this paper</a> and combining it with sample-level clinical annotations in one of <a href="https://keyes-timothy.github.io/tidytof">tidytof</a>’s built-in data objects (<code>ddpr_metadata</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># link for downloading the sample-level data from the Nature Medicine website</span>
<span class="va">data_link</span> <span class="op">&lt;-</span> 
  <span class="st">"https://static-content.springer.com/esm/art%3A10.1038%2Fnm.4505/MediaObjects/41591_2018_BFnm4505_MOESM3_ESM.csv"</span>

<span class="co"># downloading the data and combining it with clinical annotations</span>
<span class="va">ddpr_patients</span> <span class="op">&lt;-</span> 
  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">data_link</span>, skip <span class="op">=</span> <span class="fl">2L</span>, n_max <span class="op">=</span> <span class="fl">78L</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>patient_id <span class="op">=</span> <span class="va">Patient_ID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ddpr_metadata</span>, by <span class="op">=</span> <span class="st">"patient_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">patient_id</span>, <span class="st">"Healthy"</span><span class="op">)</span><span class="op">)</span>

<span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="op">~</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span>
<span class="co">#&gt;   patient_id gender mrd_risk nci_rome_risk relapse_status type_of_relapse cohort</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> UPN1       Male   Interme… Standard      Yes            Early           Train…</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> UPN1-Rx    Male   Interme… Standard      Yes            Early           Train…</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> UPN2       Male   Interme… Standard      No             <span style="color: #BB0000;">NA</span>              Train…</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> UPN3       Female Standard Standard      No             <span style="color: #BB0000;">NA</span>              Train…</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> UPN4       Male   Standard Standard      No             <span style="color: #BB0000;">NA</span>              Valid…</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> UPN5       Female Standard High          No             <span style="color: #BB0000;">NA</span>              Valid…</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 1 more variable: ddpr_risk &lt;chr&gt;</span></span></code></pre></div>
<p>The data processing steps above result in the <code>ddpr_patients</code> tibble. The numeric columns in <code>ddpr_patients</code> represent aggregated cell population features for each sample (see <a href="https://www.nature.com/articles/nm.4505#MOESM3" class="external-link">Supplementary Table 5 in this paper</a> for details). The non-numeric columns represent clinical metadata about each sample (run <code><a href="../reference/ddpr_metadata.html">?ddpr_metadata</a></code> for more information).</p>
<p>There are also a few preprocessing steps that we might want to perform now to save us some headaches when we’re fitting models later.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ddpr_patients</span> <span class="op">&lt;-</span> 
  <span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="co"># convert the relapse_status variable to a factor first, </span>
  <span class="co"># which is something we'll want for fitting the model later</span>
  <span class="co"># and create the time_to_event and event columns for survival modeling</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    relapse_status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span>, 
    time_to_event <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">relapse_status</span> <span class="op">==</span> <span class="st">"Yes"</span>, <span class="va">time_to_relapse</span>, <span class="va">ccr</span><span class="op">)</span>,
    event <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">relapse_status</span> <span class="op">==</span> <span class="st">"Yes"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>In the original DDPR paper, some patients were used to fit the model and the rest were used to assess the model after it was tuned. We can separate our training and validation cohorts using the <code>cohort</code> variable in <code>ddpr_patients</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ddpr_training</span> <span class="op">&lt;-</span> 
  <span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"Training"</span><span class="op">)</span> 

<span class="va">ddpr_validation</span> <span class="op">&lt;-</span> 
  <span class="va">ddpr_patients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"Validation"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ddpr_training</span><span class="op">)</span>
<span class="co">#&gt; [1] 49</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ddpr_validation</span><span class="op">)</span>
<span class="co">#&gt; [1] 12</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="building-a-classifier-using-elastic-net-regularized-logistic-regression">Building a classifier using elastic net-regularized logistic regression<a class="anchor" aria-label="anchor" href="#building-a-classifier-using-elastic-net-regularized-logistic-regression"></a>
</h2>
<p>First, we can build an elastic net classifier to predict which patients will relapse and which patients won’t (ignoring time-to-event data for now). For this, we can use the <code>relapse_status</code> column in <code>ddpr_training</code> as the outcome variable:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># find how many of each outcome we have in our cohort</span>
<span class="va">ddpr_training</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span>
<span class="co">#&gt;   relapse_status     n</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> No                31</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Yes               18</span></code></pre></div>
<p>Specifically, we can use the <code><a href="../reference/tof_split_data.html">tof_split_data()</a></code> function to split our cohort into a training and test set either once (a “simple” split) or multiple times (using either k-fold cross-validation or bootstrapping). In this case, we use 5-fold cross-validation, but reading the documentation of <code><a href="../reference/tof_split_data.html">tof_split_data()</a></code> demonstrates how to use other methods.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">training_split</span> <span class="op">&lt;-</span> 
  <span class="va">ddpr_training</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_split_data.html">tof_split_data</a></span><span class="op">(</span>
    split_method <span class="op">=</span> <span class="st">"k-fold"</span>, 
    num_cv_folds <span class="op">=</span> <span class="fl">5</span>, 
    strata <span class="op">=</span> <span class="va">relapse_status</span>
  <span class="op">)</span>

<span class="va">training_split</span>
<span class="co">#&gt; #  5-fold cross-validation using stratification </span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span>
<span class="co">#&gt;   splits          id   </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #949494;">&lt;split [38/11]&gt;</span> Fold1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> <span style="color: #949494;">&lt;split [39/10]&gt;</span> Fold2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="color: #949494;">&lt;split [39/10]&gt;</span> Fold3</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> <span style="color: #949494;">&lt;split [40/9]&gt;</span>  Fold4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> <span style="color: #949494;">&lt;split [40/9]&gt;</span>  Fold5</span></code></pre></div>
<p>The output of <code><a href="../reference/tof_split_data.html">tof_split_data()</a></code> varies depending on which <code>split_method</code> is used. For cross-validation, the result is a <code>rset</code> object from the <a href="https://rsample.tidymodels.org/" class="external-link">rsample</a> package. <code>rset</code> objects are a type of tibble with two columns:</p>
<ul>
<li>
<code>splits</code> - a column in which each entry is an <code>rsplit</code> object (which contains a single resample of the full dataset)</li>
<li>
<code>id</code> - a character column in which each entry represents the name of the fold that each entry in <code>splits</code> belongs to.</li>
</ul>
<p>We can inspect one of the resamples in the <code>splits</code> column to see what they contain:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_resample</span> <span class="op">&lt;-</span> <span class="va">training_split</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">my_resample</span><span class="op">)</span>
<span class="co">#&gt; &lt;Analysis/Assess/Total&gt;</span>
<span class="co">#&gt; &lt;38/11/49&gt;</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">my_resample</span><span class="op">)</span>
<span class="co">#&gt; [1] "vfold_split" "rsplit"</span></code></pre></div>
<p>Note that you can use <code><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">rsample::training</a></code> and <code><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">rsample::testing</a></code> to return the training and test obeservations from each resampling:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_resample</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 1,854</span></span>
<span class="co">#&gt;   patient_id Pop_P_Pop1 CD19_Pop1 CD20_Pop1 CD24_Pop1 CD34_Pop1 CD38_Pop1</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> UPN2            0.139    0.066<span style="text-decoration: underline;">2</span>   0.022<span style="text-decoration: underline;">1</span>     0.082<span style="text-decoration: underline;">5</span>      2.25     0.454</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> UPN3            0.633    0.023<span style="text-decoration: underline;">4</span>   0.016<span style="text-decoration: underline;">5</span>     0.032<span style="text-decoration: underline;">7</span>      2.25     0.226</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> UPN6            5.62     0.550    0.003<span style="text-decoration: underline;">74</span>    0.622       2.86     0.342</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> UPN7            0.474    0.966    0.124      1.24        2.59     0.243</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> UPN8            0.951    0.958    0.161      0.556       3.18     0.556</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> UPN9           15.6      0.446    0.044<span style="text-decoration: underline;">5</span>     0.163       2.86     0.434</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 1,847 more variables: CD127_Pop1 &lt;dbl&gt;, CD179a_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   CD179b_Pop1 &lt;dbl&gt;, IgMi_Pop1 &lt;dbl&gt;, IgMs_Pop1 &lt;dbl&gt;, TdT_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   CD22_Pop1 &lt;dbl&gt;, tIkaros_Pop1 &lt;dbl&gt;, CD79b_Pop1 &lt;dbl&gt;, Ki67_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   TSLPr_Pop1 &lt;dbl&gt;, RAG1_Pop1 &lt;dbl&gt;, CD123_Pop1 &lt;dbl&gt;, CD45_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   CD10_Pop1 &lt;dbl&gt;, Pax5_Pop1 &lt;dbl&gt;, CD43_Pop1 &lt;dbl&gt;, CD58_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   HLADR_Pop1 &lt;dbl&gt;, p4EBP1_FC_Basal_Pop1 &lt;dbl&gt;, pSTAT5_FC_Basal_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   pPLCg1_2_FC_Basal_Pop1 &lt;dbl&gt;, pAkt_FC_Basal_Pop1 &lt;dbl&gt;, …</span></span>

<span class="va">my_resample</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 1,854</span></span>
<span class="co">#&gt;   patient_id Pop_P_Pop1 CD19_Pop1 CD20_Pop1 CD24_Pop1 CD34_Pop1 CD38_Pop1</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> UPN1          3.06       0.583   0.004<span style="text-decoration: underline;">49</span>      0.164      1.94     0.416</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> UPN1-Rx       0.039<span style="text-decoration: underline;">5</span>     0.618   0.063<span style="text-decoration: underline;">4</span>       0.572      2.93     0.944</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> UPN10         0.003<span style="text-decoration: underline;">74</span>    0.761   0.000<span style="text-decoration: underline;">696</span>     0.829      3.19     0.886</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> UPN11         0.332      0.488   0.014<span style="text-decoration: underline;">6</span>       0.598      2.16     0.320</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> UPN13         0.063<span style="text-decoration: underline;">4</span>     0.030<span style="text-decoration: underline;">0</span>  0.021<span style="text-decoration: underline;">9</span>       0.109      2.34     0.314</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> UPN22         3.29       1.63    0.128        0.525      3.38     0.688</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 1,847 more variables: CD127_Pop1 &lt;dbl&gt;, CD179a_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   CD179b_Pop1 &lt;dbl&gt;, IgMi_Pop1 &lt;dbl&gt;, IgMs_Pop1 &lt;dbl&gt;, TdT_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   CD22_Pop1 &lt;dbl&gt;, tIkaros_Pop1 &lt;dbl&gt;, CD79b_Pop1 &lt;dbl&gt;, Ki67_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   TSLPr_Pop1 &lt;dbl&gt;, RAG1_Pop1 &lt;dbl&gt;, CD123_Pop1 &lt;dbl&gt;, CD45_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   CD10_Pop1 &lt;dbl&gt;, Pax5_Pop1 &lt;dbl&gt;, CD43_Pop1 &lt;dbl&gt;, CD58_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   HLADR_Pop1 &lt;dbl&gt;, p4EBP1_FC_Basal_Pop1 &lt;dbl&gt;, pSTAT5_FC_Basal_Pop1 &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   pPLCg1_2_FC_Basal_Pop1 &lt;dbl&gt;, pAkt_FC_Basal_Pop1 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>From here, we can feed <code>training_split</code> into the <code>tof_train_model</code> function to <a href="https://www.tmwr.org/tuning.html" class="external-link">tune</a> a logistic regression model that predicts the relapse_status of a leukemia patient. Be sure to check out the <code>tof_create_grid</code> documentation to learn how to make a hyperparameter search grid for model tuning (in this case, we limit the mixture parameter to a value of 1, which fits a sparse lasso model).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">class_mod</span> <span class="op">&lt;-</span> 
  <span class="va">training_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_train_model.html">tof_train_model</a></span><span class="op">(</span>
    predictor_cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"Pop2"</span><span class="op">)</span>, 
    response_col <span class="op">=</span> <span class="va">relapse_status</span>,
    model_type <span class="op">=</span> <span class="st">"two-class"</span>, 
    hyperparameter_grid <span class="op">=</span> <span class="fu"><a href="../reference/tof_create_grid.html">tof_create_grid</a></span><span class="op">(</span>mixture_values <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, 
    impute_missing_predictors <span class="op">=</span> <span class="cn">TRUE</span>, 
    remove_zv_predictors <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># often a smart decision</span>
  <span class="op">)</span></code></pre></div>
<p>The output of <code>tof_train_model</code> is a <code>tof_model</code>, an object containing information about the trained model (and that can be passed to the <code>tof_predict</code> and <code>tof_assess_model</code> verbs). When a <code>tof_model</code> is printed, some information about the optimal hyperparamters is printed, and so is a table of the nonzero model coefficients in the model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">class_mod</span><span class="op">)</span>
<span class="co">#&gt; A two-class `tof_model` with a mixture parameter (alpha) of 1 and a penalty parameter (lambda) of 1e-05 </span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 25 × 2</span></span>
<span class="co">#&gt;    feature             coefficient</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> p4EBP1_dP_IL7_Pop2        -<span style="color: #BB0000;">2.59</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CD58_Pop2                  2.23</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> (Intercept)               -<span style="color: #BB0000;">1.83</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> pSTAT5_dP_TSLP_Pop2        1.69</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> p4EBP1_FC_IL7_Pop2         1.46</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> CD43_Pop2                  1.37</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> HLADR_Pop2                -<span style="color: #BB0000;">1.32</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> pSyk_dP_TSLP_Pop2          1.08</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> pErk_dP_IL7_Pop2          -<span style="color: #BB0000;">1.05</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Ki67_Pop2                 -<span style="color: #BB0000;">1.05</span></span>
<span class="co">#&gt; <span style="color: #949494;"># … with 15 more rows</span></span></code></pre></div>
<p>We can then use the trained model to make predictions on the validation data that we set aside earlier:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">class_predictions</span> <span class="op">&lt;-</span> 
  <span class="va">class_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_predict.html">tof_predict</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">ddpr_validation</span>, prediction_type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span>

<span class="va">ddpr_validation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">class_predictions</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">relapse_status</span>, <span class="va">.pred</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span>
<span class="co">#&gt;   relapse_status .pred     n</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> No             No        5</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> No             Yes       1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Yes            No        4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Yes            Yes       2</span>

<span class="va">accuracy</span> <span class="op">&lt;-</span> 
  <span class="va">ddpr_validation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">class_predictions</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">.pred</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">relapse_status</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/accuracy.html" class="external-link">accuracy</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">relapse_status</span>, estimate <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<p>So we can see that our accuracy is about 0.583.</p>
<p>We can also assess the model directly using <code>tof_assess_model</code></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># calling the function with no new_data gives us the assessment on </span>
<span class="co"># the training data</span>
<span class="va">training_assessment</span> <span class="op">&lt;-</span> 
  <span class="va">class_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_assess_model.html">tof_assess_model</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">training_assessment</span>
<span class="co">#&gt; $model_metrics</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span>
<span class="co">#&gt;   metric                    value</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> binomial_deviance       0.029<span style="text-decoration: underline;">1</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> misclassification_error 0      </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> roc_auc                 1      </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> mse                     0.001<span style="text-decoration: underline;">19</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> mae                     0.028<span style="text-decoration: underline;">5</span> </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $roc_curve</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 49 × 2</span></span>
<span class="co">#&gt;      FPR    TPR</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     0 0.055<span style="text-decoration: underline;">6</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     0 0.111 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     0 0.167 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     0 0.222 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     0 0.278 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     0 0.333 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     0 0.389 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     0 0.444 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     0 0.5   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     0 0.556 </span>
<span class="co">#&gt; <span style="color: #949494;"># … with 39 more rows</span></span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $confusion_matrix</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span>
<span class="co">#&gt;   true_outcome predicted_outcome num_observations</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> No           No                              31</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> No           Yes                              0</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Yes          No                               0</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Yes          Yes                             18</span></code></pre></div>
<p>And we can make an ROC curve using our metrics:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">auc</span> <span class="op">&lt;-</span> 
  <span class="va">training_assessment</span><span class="op">$</span><span class="va">model_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">metric</span> <span class="op">==</span> <span class="st">"roc_auc"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>

<span class="va">training_assessment</span><span class="op">$</span><span class="va">roc_curve</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">FPR</span>, y <span class="op">=</span> <span class="va">TPR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>
    slope <span class="op">=</span> <span class="fl">1</span>, 
    intercept <span class="op">=</span> <span class="fl">0</span>, 
    linetype <span class="op">=</span> <span class="st">"dotted"</span>, 
    color <span class="op">=</span> <span class="st">"gray60"</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    subtitle <span class="op">=</span> <span class="st">"Training performance"</span>, 
    caption <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html" class="external-link">str_glue</a></span><span class="op">(</span><span class="st">"AUC = {auc}"</span>, auc <span class="op">=</span> <span class="va">auc</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="modeling_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>We can then assess the model on the validation data</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">validation_assessment</span> <span class="op">&lt;-</span> 
  <span class="va">class_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_assess_model.html">tof_assess_model</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">ddpr_validation</span><span class="op">)</span>

<span class="va">validation_assessment</span>
<span class="co">#&gt; $model_metrics</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span>
<span class="co">#&gt;   metric                  value</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> binomial_deviance       4.75 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> misclassification_error 0.417</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> roc_auc                 0.639</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> mse                     0.759</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> mae                     0.879</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $roc_curve</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 2</span></span>
<span class="co">#&gt;      FPR   TPR</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0.167 0    </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 0.167 0.167</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 0.167 0.333</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 0.333 0.333</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 0.333 0.5  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 0.333 0.667</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 0.333 0.833</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 0.5   0.833</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 0.667 0.833</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 0.833 0.833</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">11</span> 0.833 1    </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">12</span> 1     1    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $confusion_matrix</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span>
<span class="co">#&gt;   true_outcome predicted_outcome num_observations</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> No           No                               5</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> No           Yes                              1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Yes          No                               4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Yes          Yes                              2</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">auc</span> <span class="op">&lt;-</span> 
  <span class="va">validation_assessment</span><span class="op">$</span><span class="va">model_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">metric</span> <span class="op">==</span> <span class="st">"roc_auc"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>

<span class="va">validation_assessment</span><span class="op">$</span><span class="va">roc_curve</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">FPR</span>, y <span class="op">=</span> <span class="va">TPR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>
    slope <span class="op">=</span> <span class="fl">1</span>, 
    intercept <span class="op">=</span> <span class="fl">0</span>, 
    linetype <span class="op">=</span> <span class="st">"dotted"</span>, 
    color <span class="op">=</span> <span class="st">"gray60"</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    subtitle <span class="op">=</span> <span class="st">"Validation performance"</span>, 
    caption <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html" class="external-link">str_glue</a></span><span class="op">(</span><span class="st">"AUC = {auc}"</span>, auc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">auc</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="modeling_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="building-a-survival-model-using-elastic-net-regularized-cox-regression">Building a survival model using elastic net-regularized cox regression<a class="anchor" aria-label="anchor" href="#building-a-survival-model-using-elastic-net-regularized-cox-regression"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">survival_mod</span> <span class="op">&lt;-</span> 
  <span class="va">training_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_train_model.html">tof_train_model</a></span><span class="op">(</span>
    predictor_cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"Pop2"</span><span class="op">)</span>, 
    time_col <span class="op">=</span> <span class="va">time_to_event</span>, 
    event_col <span class="op">=</span> <span class="va">event</span>, 
    model_type <span class="op">=</span> <span class="st">"survival"</span>, 
    hyperparameter_grid <span class="op">=</span> <span class="fu"><a href="../reference/tof_create_grid.html">tof_create_grid</a></span><span class="op">(</span>mixture_values <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, 
    impute_missing_predictors <span class="op">=</span> <span class="cn">TRUE</span>, 
    remove_zv_predictors <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># often a smart decision</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">survival_mod</span><span class="op">)</span>
<span class="co">#&gt; A survival `tof_model` with a mixture parameter (alpha) of 1 and a penalty parameter (lambda) of 1e+00 </span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 2</span></span>
<span class="co">#&gt; <span style="color: #949494;"># … with 2 variables: feature &lt;chr&gt;, coefficient &lt;dbl&gt;</span></span></code></pre></div>
<p>Making predictions using the survival model</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">survival_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_predict.html">tof_predict</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">ddpr_validation</span>, prediction_type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 1</span></span>
<span class="co">#&gt;    .pred</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">11</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">12</span>     1</span></code></pre></div>
<p>Assessing the survival model</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">survival_assessment</span> <span class="op">&lt;-</span> 
  <span class="va">survival_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tof_assess_model.html">tof_assess_model</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">ddpr_validation</span><span class="op">)</span>

<span class="va">survival_assessment</span>
<span class="co">#&gt; $model_metrics</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span>
<span class="co">#&gt;   metric                     value</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> neg_log_partial_likelihood  19.6</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> concordance_index            0.5</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $survival_curves</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 2</span></span>
<span class="co">#&gt;    row_index survival_curve   </span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 3         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 4         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 5         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 6         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 7         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 8         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 9         <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 10        <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">11</span> 11        <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">12</span> 12        <span style="color: #949494;">&lt;tibble [44 × 2]&gt;</span></span></code></pre></div>
<p>And we can use some of these values to make a survival curve for each patient</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">survival_assessment</span><span class="op">$</span><span class="va">survival_curves</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">survival_curve</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>
    y <span class="op">=</span> 
      <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
        ddpr_risk <span class="op">=</span> <span class="va">ddpr_validation</span><span class="op">$</span><span class="va">ddpr_risk</span>, 
        row_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ddpr_validation</span><span class="op">)</span><span class="op">)</span>
      <span class="op">)</span>, 
    by <span class="op">=</span> <span class="st">"row_index"</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="co"># something is weird about the first patient</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">row_index</span> <span class="op">!=</span> <span class="st">"1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">ddpr_risk</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>probability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">probability</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">probability</span>, color <span class="op">=</span> <span class="va">ddpr_risk</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p><img src="modeling_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Timothy Keyes.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
